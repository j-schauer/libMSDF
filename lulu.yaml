version: 0.2.0
name: libMSDF

# Single glyph MSDF generation via WASM

deps:
  node-modules:
    type: transient
    path: node_modules/
    export: []
    notes: "esbuild, typescript, dts-bundle-generator"
    update: npm install

  msdf-atlas-gen:
    type: vendored
    path: vendor/msdf-atlas-gen/
    export: []
    notes: "MSDF glyph generation C++ library (Chlumsky). We use msdfgen/core/ and msdfgen/ext/ only."
    update: echo "git submodule - update manually"

  pixl:
    type: transient
    path: lib/pixl/
    export: []
    notes: "PixiJS for example/glyph shader demo - github:j-schauer/pixl"
    update: lulu depot github j-schauer/pixl 'pixl-*.zip' lib/pixl/ --latest

build:
  _wasm:
    - |
      mkdir -p build
      make -f Makefile.wasm

  _types:
    - npx dts-bundle-generator -o build/libMSDF.d.ts src/index.ts --no-check 2>/dev/null || echo "Types generation skipped"

  _dist:
    - |
      @deps
      @build._wasm
      @build._types
      mkdir -p dist
      npx esbuild src/index.ts --bundle --format=esm --platform=neutral --target=es2020 \
        --external:module \
        --outfile=dist/libMSDF.js
      cp build/libmsdf-core.wasm dist/libMSDF.wasm
      cp build/libMSDF.d.ts dist/ 2>/dev/null || true
      cp src/shader.js dist/
      cp docs/api.md dist/

run:
  tests:
    - |
      @deps
      @build._wasm
      mkdir -p dist/assets
      npx esbuild src/index.ts --bundle --format=esm --platform=neutral --target=es2020 \
        --external:module \
        --outfile=dist/libMSDF.js
      cp build/libmsdf-core.wasm dist/libMSDF.wasm
      cp assets/*.ttf dist/assets/
      npx tsc tests/test-msdf.ts --target esnext --module esnext --moduleResolution node --outDir dist --skipLibCheck
      cd dist && node test-msdf.js

  example:
    - |
      @deps
      echo "Open http://localhost:8000/example/glyph/"
      npx http-server . -p 8000 --cors -c-1

clean:
  - rm -rf build dist node_modules
